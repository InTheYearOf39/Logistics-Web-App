{% extends 'dashboard_base.html' %}

{% load static %}

{% block content %}

<div class="container px-5 pb-5" data-aos="fade-up">
    <div class="row g-5">
        
        <div class="col-md-8 col-lg-10">
          <h4 class="my-5">Add Package</h4>
          
          <form class="needs-validation" novalidate action="{% url 'register_package' %}" method="post" id="packageForm" onsubmit="populateLocation()">
            {% csrf_token %}
            <div class="row g-3">
              <div class="col-sm-6">
                <label for="packageName" class="form-label">Package Name</label>
                <input type="text" class="form-control" id="packageName" name="packageName" placeholder="Package Name" value="" required>
                <div class="invalid-feedback">
                  Valid Package name is required.
                </div>
              </div>

              <div class="col-12">
                <label for="deliveryType" class="form-label">Delivery Type</label>
                <select class="form-select" id="deliveryType" name="deliveryType" required>
                  <option value="" selected disabled>-- Select Delivery Type --</option>
                  <option value="standard">Standard</option>
                  <option value="premium">Premium</option>
                  <option value="express">Express</option>
                </select>
                <div class="invalid-feedback">
                  Please select a delivery type.
                </div>
              </div>
              
              <div class="col-12" id="dropOffLocationContainer" style="display: none;">
                <label for="dropOffLocation" class="form-label">Drop Off Location</label>
                <select class="form-control" id="dropOffLocation" name="dropOffLocation" required>
                  <option value="" selected disabled>-- Select Drop Off Location --</option>
                  {% for drop_pick_zone in drop_pick_zones %}
                    <option value="{{ drop_pick_zone.id }}">{{ drop_pick_zone.name }}</option>
                  {% endfor %}
                </select>
                <div class="invalid-feedback">
                  Please select a delivery location.
                </div>
               
              </div>
              

            <input type="hidden" id="sender_latitude" name="sender_latitude" value="">
            <input type="hidden" id="sender_longitude" name="sender_longitude" value="">

              
              <script>
                const deliveryTypeSelect = document.getElementById("deliveryType");
                const dropOffLocationContainer = document.getElementById("dropOffLocationContainer");
              
                deliveryTypeSelect.addEventListener("change", function() {
                  if (this.value === "standard") {
                    dropOffLocationContainer.style.display = "block";
                  } else {
                    dropOffLocationContainer.style.display = "none";
                  }
                });
              </script>
              

              <div class="col-12">
                <label for="packageDescripton" class="form-label">Package Description</label>
                <div class="input-group has-validation">
                  <input type="text" class="form-control" id="packageDescription" name="packageDescription" placeholder="Enter Description" required>
                <div class="invalid-feedback">
                  Package Description is required.
                  </div>
                </div>
              </div>
  
              <div class="col-12">
                <label for="recipientName" class="form-label">Recipient Name</label>
                <div class="input-group has-validation">
                  <input type="text" class="form-control" id="recipientName" name="recipientName" placeholder="Recipient Name" required>
                <div class="invalid-feedback">
                    Recipient Name is required.
                  </div>
                </div>
              </div>

              <div class="col-12">
                <label for="recipientEmail" class="form-label">Recipient Email</label>
                <div class="input-group has-validation">
                  <input type="email" class="form-control" id="recipientEmail" name="recipientEmail" placeholder="Recipient Email" required>
                <div class="invalid-feedback">
                    Recipient Email is required.
                  </div>
                </div>
              </div>

              <div class="col-12">
                <label for="recipientTelephone" class="form-label">Recipient Telephone</label>
                <div class="input-group has-validation">
                  <input type="tel" class="form-control" id="recipientTelephone" name="recipientTelephone" placeholder="Recipient Telephone" pattern="[0-9]{10}" required>
                  <div class="invalid-feedback">
                    Please enter a valid ten-digit telephone number.
                  </div>
                </div>
              </div>
              
              <input type="hidden" id="recipient_latitude" name="recipient_latitude" value="">
              <input type="hidden" id="recipient_longitude" name="recipient_longitude" value="">
  
              <div class="col-12">
                <label for="recipientAddress" class="form-label">Recipient Address</label>
                <input id="recipientAddress" name="recipientAddress" placeholder="Recipient Address" class="form-control" type="text">
                <div class="invalid-feedback">
                  Please enter a valid email address for shipping updates.
                </div>
              </div>

                <!-- Add this new <div> for the recipient drop-off location -->
                  <div class="col-12" id="recipientPickUpLocationContainer">
                    <label for="recipientPickUpLocation" class="form-label">Recipient Drop Off Location</label>
                    <select class="form-control" id="recipientPickUpLocation" name="recipientPickUpLocation" required>
                      <option value="" selected disabled>-- Select Recipient Drop Off Location --</option>
                      {% for drop_pick_zone in drop_pick_zones %}
                        <option value="{{ drop_pick_zone.id }}">{{ drop_pick_zone.name }}</option>
                      {% endfor %}
                    </select>
                    <div class="invalid-feedback">
                      Please select a recipient drop-off location.
                    </div>
                  </div>
                  

              <div class="col-12">
                <label for="sendersAddress" class="form-label"> Sender's Address</label>
                <input id="senderAddress" name="sendersAddress" placeholder="Sender's Address" class="form-control" type="text">
                <div class="invalid-feedback">
                  Please enter your shipping address.
                </div>
              </div>
              
              <div class="col-sm-3 col-md-12">
                <button class="w-100 btn btn-primary btn-25-on-lg text-white" type="submit">Click to confirm</button>
              </div>
          </form>
        </div>
      </div>
  </div>


  <script>
    
    function getGPS() {
    // pick the location
    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(function (position) {
        //console.log(position.coords);
        //set the GPS into feilds
        const sender_latitude = position.coords.latitude;
        const sender_longitude = position.coords.longitude;
        document.getElementById("sender_latitude").value = sender_latitude;
        document.getElementById("sender_longitude").value = sender_longitude;

        //get human readable name for current GPS location
        //get cordinates

        var request = new XMLHttpRequest();
        var g_key= '{{ api_key }}';
        var method = 'GET';
        var url = 'https://maps.googleapis.com/maps/api/geocode/json?latlng='+sender_latitude+','+sender_longitude+'&sensor=true'+'&key='+g_key;
        var async = true;

        request.open(method, url, async);
        request.onreadystatechange = function(){
          if(request.readyState == 4 && request.status == 200){
            var data = JSON.parse(request.responseText);
            var address = data.results[0];
            //console.log(address.formatted_address);
            document.getElementById("senderAddress").value = address.formatted_address;
          }

        };
        request.send();

        // get new droplist
        redraw_dropoff_list(sender_latitude, sender_longitude);

      }, function (error) {
        console.log("Failed to get location");
        alert("Failed to get your GPS location. Please enable GPS.");
        console.log(error);
      }, { maximumAge: 0, enableHighAccuracy: true });
    } else {
      console.log("Device does not support geolocation!");
      alert("Device does not support geolocation!");
    }
  }

  //get drop lits in javacsript
  /*
  var drop_lists = {{ drop_pick_zones_json|safe }};
  */

  function redraw_dropoff_list(lat, lng)
  {

    $.ajax({
        method: "POST",
        url: "/api",
        data: { action: "get_closest_drop_pick_locations", lat: lat, lng: lng }
    }).done(function( response ) {
        //console.log(response);
        //overide options
        $("#dropOffLocation").html(response.data);
    });

  }

  function populateRecipientLocation() {
    // Function to populate recipient drop-off locations
    const recipientAddressInput = document.getElementById("recipientAddress");
    const recipientLatitudeInput = document.getElementById("recipient_latitude");
    const recipientLongitudeInput = document.getElementById("recipient_longitude");
    const recipientPickUpLocationContainer = document.getElementById("recipientPickUpLocationContainer");

    if (recipientAddressInput.value !== "") {
      // Perform actions to populate recipient drop-off locations based on the recipient's address
      const recipient_latitude = recipientLatitudeInput.value;
      const recipient_longitude = recipientLongitudeInput.value;
      redraw_recipient_dropoff_list(recipient_latitude, recipient_longitude);
      recipientPickUpLocationContainer.style.display = "block";
    } else {
      recipientPickUpLocationContainer.style.display = "none";
    }
  }

  // Call the function when the recipient address input changes
  const recipientAddressInput = document.getElementById("recipientAddress");
  recipientAddressInput.addEventListener("change", populateRecipientLocation);

  function redraw_recipient_dropoff_list(lat, lng) {
    // Function to redraw recipient drop-off locations based on recipient's latitude and longitude
    $.ajax({
      method: "POST",
      url: "/api",
      data: { action: "get_closest_drop_pick_locations", lat: lat, lng: lng },
    }).done(function (response) {
      // Sort the drop-off locations based on distance before populating the dropdown
      const dropOffLocationSelect = $("#recipientPickUpLocation");
      dropOffLocationSelect.html(response.data);
      
      // Note: We are not selecting any option here, so the user can choose from the list of closest drop-off locations.
    });
  }

  // Call the function once when the page loads
  getGPS();
</script>

<script>
  // Load after page loads
  $(function() {
    // Initiate autocomplete for the recipient address field
    var recipientAutocomplete = new google.maps.places.Autocomplete($("#recipientAddress")[0], {});

    google.maps.event.addListener(recipientAutocomplete, 'place_changed', function() {
      var place = recipientAutocomplete.getPlace();
      // Log or process the selected place if needed
      //set values into the feilds
      $("#recipient_latitude").val(place.geometry.location.lat());
      $("#recipient_longitude").val(place.geometry.location.lng());

    });

    // Initiate autocomplete for the sender's address field
    var senderAutocomplete = new google.maps.places.Autocomplete($("#senderAddress")[0], {});

    google.maps.event.addListener(senderAutocomplete, 'place_changed', function() {
      var place = senderAutocomplete.getPlace();
      // Log or process the selected place if needed
      //set values into the feilds
      document.getElementById("sender_latitude").value = place.geometry.location.lat();
      document.getElementById("sender_longitude").value = place.geometry.location.lng();

      // get new droplist
      redraw_dropoff_list(place.geometry.location.lat(), place.geometry.location.lng());

    });
  });
</script>

{% endblock %}
